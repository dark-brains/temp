#if 0
	shc Version 4.0.3, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -f client_assume_role.sh -o car_mac 
#endif

static  char data [] = 
#define      chk1_z	22
#define      chk1	((&data[5]))
	"\103\316\134\274\255\027\275\042\206\113\333\227\233\012\200\036"
	"\335\060\144\033\010\354\104\174\233\267\051\140\365\320\070"
#define      xecc_z	15
#define      xecc	((&data[32]))
	"\267\005\224\342\256\001\206\207\306\127\354\332\072\125\223\144"
	"\375\307\351"
#define      lsto_z	1
#define      lsto	((&data[50]))
	"\276"
#define      msg2_z	19
#define      msg2	((&data[54]))
	"\073\171\167\206\217\145\346\130\161\134\310\243\173\261\361\264"
	"\250\006\027\336\121\214\060\150\305\340"
#define      rlax_z	1
#define      rlax	((&data[77]))
	"\051"
#define      opts_z	1
#define      opts	((&data[78]))
	"\300"
#define      shll_z	8
#define      shll	((&data[79]))
	"\252\106\121\276\125\347\071\017"
#define      text_z	2565
#define      text	((&data[660]))
	"\373\061\147\135\221\010\105\307\074\220\143\213\031\157\241\017"
	"\132\123\011\322\100\331\141\304\062\211\267\070\214\121\353\260"
	"\274\303\342\114\346\141\115\120\110\111\350\326\340\376\367\055"
	"\116\250\276\343\120\357\113\261\136\234\154\105\320\300\172\327"
	"\363\332\344\121\163\053\361\214\336\372\070\336\273\136\032\270"
	"\044\347\350\041\126\171\163\337\010\123\262\125\346\161\244\062"
	"\055\160\210\007\167\173\373\307\216\264\320\240\223\144\061\006"
	"\100\035\206\153\005\365\201\154\074\334\043\244\315\120\001\235"
	"\003\062\320\136\275\074\134\214\034\337\124\346\156\270\011\320"
	"\260\355\247\342\336\122\252\117\344\341\172\071\044\177\017\361"
	"\133\200\127\133\201\342\377\134\222\257\276\360\316\366\272\312"
	"\003\232\047\235\006\237\276\264\205\037\057\123\100\207\157\137"
	"\360\345\366\372\127\047\023\363\217\275\343\254\140\272\076\110"
	"\132\367\300\154\171\157\246\166\207\253\252\333\241\012\314\043"
	"\311\322\252\110\112\103\210\251\342\211\353\160\170\206\313\143"
	"\220\215\126\356\120\340\034\337\054\050\056\102\106\244\076\047"
	"\041\322\150\260\206\322\366\017\142\205\100\245\007\335\110\334"
	"\267\314\340\330\036\050\343\332\114\233\310\361\326\214\367\027"
	"\212\174\000\374\266\363\377\105\107\364\102\132\246\245\167\030"
	"\034\132\215\100\256\253\113\353\066\344\123\364\107\346\355\247"
	"\332\075\034\165\075\323\213\142\301\320\157\025\013\376\234\014"
	"\276\356\375\176\351\353\266\227\201\013\255\003\135\106\240\333"
	"\347\257\157\074\156\363\146\345\244\165\023\132\306\377\113\224"
	"\157\032\256\133\143\223\041\006\275\230\070\254\355\207\025\014"
	"\120\302\350\324\324\152\135\123\353\061\147\350\146\114\056\111"
	"\006\046\130\056\033\211\333\244\102\150\210\321\262\221\233\076"
	"\321\046\345\266\257\157\313\201\324\061\207\207\161\206\073\107"
	"\003\035\070\255\330\113\141\256\374\317\254\216\071\012\012\142"
	"\135\014\370\214\311\230\377\125\206\266\016\035\363\227\217\170"
	"\121\024\255\337\200\263\354\263\123\130\320\376\014\342\277\343"
	"\121\066\157\214\216\376\154\233\045\160\266\037\262\036\261\016"
	"\322\200\063\254\101\056\004\056\312\122\155\310\132\034\042\115"
	"\212\171\230\221\317\113\221\000\365\003\337\216\351\172\033\060"
	"\367\101\077\066\146\144\061\356\076\322\367\347\276\225\371\317"
	"\350\325\007\257\016\371\364\305\103\206\267\231\237\262\072\116"
	"\255\141\353\375\244\134\040\367\223\370\332\105\107\067\144\215"
	"\225\012\046\212\273\247\214\122\173\215\103\260\065\054\070\105"
	"\135\161\016\051\104\136\060\304\232\216\164\235\137\125\072\177"
	"\043\277\045\247\104\334\134\115\172\304\143\351\141\226\117\276"
	"\132\336\351\152\031\066\013\071\250\237\215\150\166\265\257\103"
	"\264\247\336\152\302\072\050\206\207\130\107\260\103\076\121\242"
	"\207\131\067\226\170\362\146\216\152\300\021\066\367\005\333\351"
	"\054\167\226\053\034\236\011\152\135\232\273\301\264\303\210\054"
	"\334\346\264\065\254\277\126\212\376\104\223\341\034\220\136\143"
	"\110\170\144\140\015\116\061\336\147\331\244\013\147\307\001\133"
	"\162\143\165\046\213\055\345\122\301\261\022\357\346\306\123\232"
	"\217\341\302\140\041\053\041\327\312\044\266\134\345\231\155\166"
	"\005\207\170\370\164\134\334\027\047\374\163\000\131\352\161\272"
	"\320\055\315\112\135\270\344\002\172\210\055\170\242\301\314\336"
	"\350\125\304\205\230\370\032\174\263\011\167\352\310\277\030\163"
	"\214\243\164\220\346\330\115\003\305\016\215\270\207\045\261\075"
	"\034\124\252\105\323\120\267\106\002\331\273\263\236\207\100\203"
	"\127\041\016\141\123\131\016\200\352\010\174\232\041\053\024\222"
	"\343\073\245\174\330\055\225\303\156\326\157\224\140\271\100\064"
	"\114\311\352\212\211\350\136\271\073\267\325\135\157\376\047\171"
	"\144\057\154\113\175\057\265\044\061\246\146\062\116\354\267\346"
	"\227\022\371\214\017\126\223\323\375\366\344\337\035\311\357\206"
	"\116\051\027\357\107\065\104\067\352\076\135\147\125\135\167\371"
	"\206\315\331\044\054\031\234\325\111\164\372\034\214\274\231\222"
	"\101\051\160\124\323\034\122\041\103\310\076\143\172\022\266\065"
	"\054\140\356\276\011\145\023\051\174\267\160\327\374\202\245\063"
	"\153\347\233\213\363\064\242\002\325\232\106\156\240\033\371\214"
	"\215\202\113\256\031\077\032\275\364\337\026\115\124\357\073\115"
	"\227\175\314\365\250\206\272\071\323\101\034\063\331\026\133\263"
	"\047\340\001\302\321\330\135\317\203\120\266\202\136\261\373\134"
	"\271\311\266\373\070\133\242\265\072\230\061\124\250\270\016\354"
	"\260\043\276\163\326\113\132\320\007\352\311\105\145\000\040\076"
	"\163\100\075\324\321\104\273\356\123\203\071\363\376\364\264\324"
	"\047\041\132\216\234\250\213\141\372\117\367\220\003\127\355\136"
	"\055\251\220\022\001\137\146\202\217\325\074\343\110\020\061\051"
	"\336\255\120\372\102\203\247\150\232\125\036\137\051\000\062\356"
	"\045\023\011\116\027\120\230\031\137\231\244\051\257\174\261\202"
	"\323\105\216\160\022\311\141\264\054\141\024\360\324\026\156\006"
	"\206\105\075\247\371\306\321\231\325\053\250\130\240\004\347\127"
	"\311\127\164\143\245\322\332\321\007\356\074\143\164\075\335\330"
	"\322\336\306\115\375\162\215\251\102\332\257\232\246\175\365\006"
	"\224\354\270\005\265\355\320\016\363\171\044\075\177\217\276\306"
	"\041\357\007\250\077\370\371\044\051\132\246\333\210\245\231\166"
	"\265\135\172\145\102\105\350\156\323\200\257\046\144\052\346\360"
	"\236\002\126\062\314\207\254\263\333\270\326\242\345\234\133\326"
	"\200\227\166\354\075\117\202\051\236\255\274\366\221\224\120\247"
	"\166\236\315\233\112\211\064\335\340\217\274\342\215\002\044\365"
	"\116\026\315\023\344\107\114\052\357\142\004\303\352\316\021\033"
	"\330\071\367\271\037\142\210\307\014\364\056\366\162\201\321\324"
	"\165\014\046\177\365\116\030\126\152\061\130\272\347\154\073\175"
	"\130\346\254\037\060\203\317\013\263\365\257\261\261\201\337\020"
	"\006\002\231\044\175\231\110\046\120\357\012\200\317\345\124\043"
	"\350\340\054\243\167\047\371\150\271\025\164\327\342\275\307\352"
	"\076\066\357\017\273\332\111\267\364\243\016\033\274\137\341\171"
	"\313\037\166\101\105\377\174\142\315\042\154\065\345\026\324\353"
	"\215\372\245\164\321\372\115\006\271\340\172\304\203\312\155\172"
	"\064\360\075\313\322\147\340\350\036\270\057\377\145\364\256\061"
	"\170\111\224\127\015\255\137\054\172\101\053\166\010\176\044\367"
	"\062\004\110\304\020\056\201\126\062\376\045\326\214\243\343\345"
	"\054\170\305\012\370\245\230\362\047\230\342\270\130\032\261\314"
	"\244\022\070\167\127\062\014\101\234\061\205\262\324\271\213\334"
	"\154\315\253\131\035\000\312\175\254\120\304\137\221\347\376\013"
	"\341\024\147\127\376\047\114\326\353\143\330\276\301\062\045\024"
	"\004\301\230\155\037\124\224\325\263\004\121\172\111\302\331\327"
	"\020\172\263\035\246\372\101\134\147\355\377\010\170\046\241\252"
	"\175\042\360\062\311\145\077\000\156\213\071\324\030\324\144\375"
	"\264\113\162\300\145\240\005\003\046\221\111\056\065\316\137\106"
	"\305\375\050\100\320\070\143\363\025\123\060\020\102\270\323\302"
	"\144\017\320\121\166\077\026\077\061\013\235\037\251\111\033\360"
	"\065\011\235\345\236\014\033\076\304\261\105\312\077\261\043\200"
	"\041\037\267\261\167\172\362\276\242\117\107\112\002\226\270\134"
	"\201\161\255\072\046\210\355\256\343\040\151\141\216\106\311\317"
	"\343\100\075\143\274\242\140\335\315\300\225\156\010\026\146\311"
	"\237\153\334\224\316\336\066\134\116\234\026\364\333\022\127\010"
	"\106\042\153\266\013\341\322\307\324\202\042\324\051\036\074\137"
	"\302\252\154\161\007\311\264\237\331\262\302\230\175\055\122\221"
	"\227\214\210\060\017\105\165\336\166\367\056\157\370\345\163\303"
	"\052\277\122\357\225\230\103\151\257\004\234\276\316\024\230\104"
	"\136\041\252\362\020\052\331\376\105\026\001\045\157\333\124\263"
	"\050\131\342\312\257\235\060\243\032\342\155\013\143\154\350\251"
	"\075\302\262\263\152\144\011\273\242\132\223\317\212\005\025\065"
	"\020\015\176\074\000\375\012\240\227\027\046\241\256\171\206\146"
	"\367\007\154\122\230\227\001\321\336\124\113\150\272\336\007\216"
	"\112\223\100\166\164\247\107\352\371\200\353\154\064\375\317\354"
	"\062\371\161\174\050\324\004\373\356\001\334\374\252\201\263\021"
	"\114\261\366\314\154\225\063\014\332\072\224\335\374\360\156\060"
	"\150\335\001\043\125\331\250\271\173\057\222\155\023\173\277\016"
	"\372\373\152\173\112\015\024\052\270\112\121\262\335\366\222\171"
	"\275\150\037\006\155\251\066\207\150\260\126\051\217\326\203\061"
	"\151\152\077\046\323\040\012\323\125\117\172\021\320\203\336\212"
	"\031\022\011\031\065\002\216\253\311\331\347\341\353\314\266\136"
	"\113\063\156\302\202\044\137\161\012\142\024\107\212\004\120\122"
	"\350\221\252\324\054\175\053\354\313\114\002\316\315\164\133\230"
	"\164\352\247\201\274\315\173\357\062\360\103\023\240\306\223\100"
	"\007\257\307\334\171\107\217\304\215\125\110\216\175\160\037\006"
	"\054\326\172\231\134\030\305\305\005\202\154\274\254\370\151\251"
	"\231\067\342\111\070\347\037\102\276\030\103\312\223\060\261\111"
	"\011\261\041\213\210\014\230\213\223\051\077\330\152\320\324\161"
	"\370\361\064\135\371\257\335\136\146\213\360\251\175\226\002\020"
	"\260\014\204\117\065\024\213\156\166\265\135\323\315\275\235\247"
	"\243\243\332\375\333\021\123\301\164\146\372\043\376\223\345\266"
	"\260\173\031\357\325\371\315\141\257\101\162\143\260\154\271\102"
	"\161\326\256\154\202\354\360\256\167\235\053\142\144\271\070\043"
	"\232\137\361\143\173\073\232\211\034\023\060\304\063\046\334\102"
	"\360\302\362\205\365\226\351\251\102\115\001\227\224\235\334\104"
	"\252\026\325\315\076\045\010\004\151\132\002\172\367\171\211\314"
	"\265\336\212\372\372\201\303\213\134\276\205\172\010\331\242\143"
	"\131\305\157\220\037\123\064\054\365\112\152\023\113\155\367\262"
	"\067\251\242\247\252\115\240\262\263\131\064\246\027\000\356\203"
	"\211\002\106\026\151\247\113\271\077\126\042\310\062\116\212\004"
	"\340\225\213\127\143\140\064\032\177\243\344\254\161\233\114\323"
	"\222\174\017\116\275\075\062\220\202\217\365\304\172\376\374\145"
	"\355\012\336\143\205\140\221\155\142\200\034\345\027\370\215\067"
	"\340\077\026\035\143\160\117\130\124\311\373\075\323\067\101\242"
	"\101\244\033\074\154\246\034\304\067\156\016\172\100\346\345\236"
	"\043\377\362\174\010\021\166\331\022\200\272\211\134\107\371\106"
	"\246\010\140\271\372\202\037\010\365\217\051\361\236\352\224\011"
	"\306\043\041\304\143\142\172\126\023\367\220\267\124\012\232\215"
	"\113\274\061\316\263\016\063\022\216\351\013\026\042\367\374\260"
	"\373\112\001\001\063\023\254\343\312\176\257\202\073\201\212\221"
	"\343\075\230\252\112\235\104\160\231\162\131\173\017\245\160\217"
	"\157\232\322\361\226\020\022\145\330\034\231\251\127\175\347\360"
	"\303\017\111\160\274\023\275\373\273\347\172\112\366\260\032\036"
	"\317\024\165\131\341\162\056\044\371\032\254\334\227\320\371\343"
	"\204\350\365\145\335\066\231\144\006\103\365\134\316\031\052\143"
	"\265\234\107\207\031\275\266\376\241\103\306\141\007\214\120\346"
	"\215\352\311\010\315\326\231\335\135\251\302\275\305\003\110\134"
	"\041\000\241\110\274\342\205\151\057\337\334\230\122\236\053\315"
	"\163\174\373\324\017\162\313\337\110\303\303\040\267\272\227\232"
	"\343\203\375\004\140\002\045\147\073\041\250\171\360\151\167\100"
	"\243\162\325\277\175\104\176\065\370\266\215\366\221\051\351\237"
	"\022\316\216\370\327\020\271\206\257\005\304\107\213\031\347\303"
	"\235\073\247\357\145\003\310\373\123\000\203\101\046\104\014\163"
	"\005\220\312\266\106\271\077\214\030\123\117\277\227\277\174\166"
	"\341\114\313\006\071\067\050\231\335\057\060\133\217\375\012\234"
	"\307\155\161\034\126\045\254\167\062\212\173\014\053\220\306\365"
	"\227\204\137\147\276\070\217\373\124\253\055\014\065\116\142\075"
	"\316\321\272\311\323\033\334\241\043\126\304\310\210\113\000\252"
	"\206\177\375\337\155\160\124\301\223\161\120\223\167\103\354\372"
	"\214\116\263\170\056\066\205\324\025\017\115\067\130\205\242\374"
	"\202\226\111\046\214\121\013\342\057\234\027\304\374\060\155\114"
	"\163\003\122\333\257\316\022\035\112\023\035\031\373\027\026\146"
	"\014\142\321\076\360\041\155\366\117\204\277\266\103\150\333\351"
	"\172\272\244\152\164\033\036\350\376\061\172\147\273\334\313\006"
	"\254\032\217\023\300\207\174\227\373\164\320\274\223\005\306\124"
	"\047\035\320\024\151\136\235\333\224\244\163\125\276\162\157\001"
	"\164\203\275\021\317\035\132\102\336\226\075\147\041\243\343\216"
	"\331\053\075\245\222\024\171\102\313\045\111\053\354\227\337\323"
	"\265\034\035\265\111\077\142\075\046\011\337\376\140\126\226\244"
	"\076\370\307\027\015\302\321\336\153\022\375\132\171\162\024\341"
	"\213\152\371\167\154\372\131\023\336\230\353\244\352\213\065\013"
	"\264\135\232\152\020\260\171\047\003\147\360\361\176\264\064\150"
	"\332\017\231\175\344\262\124\261\251\006\104\052\050\251\103\133"
	"\114\123\132\216\120\130\174\366\026\013\164\112\242\125\216\334"
	"\041\037\221\212\070\237\223\243\276\260\364\030\230\161\004\004"
	"\024\322\374\315\131\217\266\241\002\064\347\136\040\165\222\217"
	"\151\141\025\102\342\112\352\256\015\060\346\232\332\302\250\357"
	"\172\201\072\005\071\067\240\252\057\056\207\367\075\362\144\265"
	"\230\121\013\357\076\142\343\231\021\311\240\103\115\000\063\333"
	"\232\271\107\106\130\370\305\221\173\001\114\126\225\252\047\361"
	"\357\317\012\312\361\127\210\005\001\273\264\114\100\100\273\151"
	"\274\070\176\350\053\237\346\263\237\004\075\162\147\351\106\155"
	"\036\307\315\146\355\126\140\247\044\113\352\353\063\167\334\134"
	"\300\130\364\112\020\305\220\002\316\326\036\034\141\076\337\135"
	"\027\110\265\260\263\222\150\107"
#define      tst1_z	22
#define      tst1	((&data[3280]))
	"\263\071\252\225\031\030\060\074\254\334\327\076\327\274\042\214"
	"\047\335\256\370\325\274\234\175\364"
#define      inlo_z	3
#define      inlo	((&data[3304]))
	"\214\223\054"
#define      tst2_z	19
#define      tst2	((&data[3307]))
	"\341\331\072\355\063\367\247\257\036\101\245\052\366\002\130\232"
	"\132\261\070\301\361\041"
#define      chk2_z	19
#define      chk2	((&data[3333]))
	"\155\276\306\047\175\271\015\334\022\213\150\306\347\371\313\305"
	"\276\260\167\163\070\244\367\100\023\162\352"
#define      pswd_z	256
#define      pswd	((&data[3362]))
	"\265\154\337\130\161\200\236\007\013\264\255\007\246\004\164\366"
	"\254\003\101\141\040\163\267\053\377\015\013\306\073\353\273\330"
	"\047\162\203\107\170\075\016\074\162\146\006\256\176\367\005\272"
	"\071\205\063\072\301\265\376\021\004\177\265\070\330\223\013\102"
	"\041\162\121\322\075\250\002\331\025\062\336\012\047\260\376\034"
	"\070\330\125\223\075\314\357\060\342\043\106\007\154\174\276\316"
	"\231\012\015\016\127\362\165\330\015\103\171\037\261\220\203\007"
	"\055\175\265\341\256\064\260\100\350\363\226\207\315\104\323\131"
	"\253\055\031\244\332\214\105\240\154\353\054\240\245\334\211\141"
	"\030\233\145\066\363\027\344\077\341\272\206\313\017\265\160\260"
	"\275\112\114\012\001\321\262\116\261\070\306\152\372\347\056\374"
	"\200\160\260\154\244\271\045\275\070\157\237\116\335\135\354\216"
	"\122\006\354\017\137\065\035\237\025\132\071\337\152\031\074\313"
	"\263\343\300\261\301\102\003\163\165\366\055\130\061\364\375\246"
	"\316\233\357\066\335\100\361\100\302\053\110\342\225\317\004\343"
	"\261\066\341\137\126\053\106\072\172\276\200\124\207\106\100\042"
	"\261\055\066\237\000\076\012\116\270\200\265\030\017\207\124\076"
	"\307\071\215\256\321\152\046\070\307\360\332\075\343\257\201\153"
	"\111\101\340\324\332\301\272\073\337\024\301\262\176\164\015\003"
	"\152\256\223\273\133\040\324\232\327\231\210\303\077\347"
#define      msg1_z	65
#define      msg1	((&data[3681]))
	"\064\234\040\370\105\133\215\225\353\046\332\077\126\076\113\214"
	"\143\371\366\370\175\335\022\043\000\344\230\020\302\020\377\062"
	"\107\124\270\064\064\053\271\111\143\250\245\105\325\175\350\014"
	"\270\056\117\270\331\054\142\057\336\113\022\227\150\364\014\010"
	"\133\176\250\325\354\013\364\351\136"
#define      date_z	1
#define      date	((&data[3747]))
	"\141"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

#if HARDENING
static const char * shc_x[] = {
"/*",
" * Copyright 2019 - Intika <intika@librefox.org>",
" * Replace ******** with secret read from fd 21",
" * Also change arguments location of sub commands (sh script commands)",
" * gcc -Wall -fpic -shared -o shc_secret.so shc_secret.c -ldl",
" */",
"",
"#define _GNU_SOURCE /* needed to get RTLD_NEXT defined in dlfcn.h */",
"#define PLACEHOLDER \"********\"",
"#include <dlfcn.h>",
"#include <stdlib.h>",
"#include <string.h>",
"#include <unistd.h>",
"#include <stdio.h>",
"#include <signal.h>",
"",
"static char secret[128000]; //max size",
"typedef int (*pfi)(int, char **, char **);",
"static pfi real_main;",
"",
"// copy argv to new location",
"char **copyargs(int argc, char** argv){",
"    char **newargv = malloc((argc+1)*sizeof(*argv));",
"    char *from,*to;",
"    int i,len;",
"",
"    for(i = 0; i<argc; i++){",
"        from = argv[i];",
"        len = strlen(from)+1;",
"        to = malloc(len);",
"        memcpy(to,from,len);",
"        // zap old argv space",
"        memset(from,'\\0',len);",
"        newargv[i] = to;",
"        argv[i] = 0;",
"    }",
"    newargv[argc] = 0;",
"    return newargv;",
"}",
"",
"static int mymain(int argc, char** argv, char** env) {",
"    //fprintf(stderr, \"Inject main argc = %d\\n\", argc);",
"    return real_main(argc, copyargs(argc,argv), env);",
"}",
"",
"int __libc_start_main(int (*main) (int, char**, char**),",
"                      int argc,",
"                      char **argv,",
"                      void (*init) (void),",
"                      void (*fini)(void),",
"                      void (*rtld_fini)(void),",
"                      void (*stack_end)){",
"    static int (*real___libc_start_main)() = NULL;",
"    int n;",
"",
"    if (!real___libc_start_main) {",
"        real___libc_start_main = dlsym(RTLD_NEXT, \"__libc_start_main\");",
"        if (!real___libc_start_main) abort();",
"    }",
"",
"    n = read(21, secret, sizeof(secret));",
"    if (n > 0) {",
"      int i;",
"",
"    if (secret[n - 1] == '\\n') secret[--n] = '\\0';",
"    for (i = 1; i < argc; i++)",
"        if (strcmp(argv[i], PLACEHOLDER) == 0)",
"          argv[i] = secret;",
"    }",
"",
"    real_main = main;",
"",
"    return real___libc_start_main(mymain, argc, argv, init, fini, rtld_fini, stack_end);",
"}",
"",
0};
#endif /* HARDENING */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a process */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void shc_x_file() {
    FILE *fp;
    int line = 0;

    if ((fp = fopen("/tmp/shc_x.c", "w")) == NULL ) {exit(1); exit(1);}
    for (line = 0; shc_x[line]; line++)	fprintf(fp, "%s\n", shc_x[line]);
    fflush(fp);fclose(fp);
}

int make() {
	char * cc, * cflags, * ldflags;
    char cmd[4096];

	cc = getenv("CC");
	if (!cc) cc = "cc";

	sprintf(cmd, "%s %s -o %s %s", cc, "-Wall -fpic -shared", "/tmp/shc_x.so", "/tmp/shc_x.c -ldl");
	if (system(cmd)) {remove("/tmp/shc_x.c"); return -1;}
	remove("/tmp/shc_x.c"); return 0;
}

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    char tmp3[len+1024];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;
    int lentmp = len;
    int pid, status;
    pid = fork();

    shc_x_file();
    if (make()) {exit(1);}

    setenv("LD_PRELOAD","/tmp/shc_x.so",1);

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Do the magic
        sprintf(tmp3, "%s %s", "'********' 21<<<", tmp2);

        //Exec bash script //fork execl with 'sh -c'
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Clean temp
        remove("/tmp/shc_x.so");

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {wait(&status);}

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
}
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
